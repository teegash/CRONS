name: Lease Renewal Reminder Scheduler

on:
  schedule:
    # 03:05 UTC â‰ˆ 06:05 Africa/Nairobi (UTC+3)
    - cron: "5 3 * * *"
  workflow_dispatch:
    inputs:
      scheduled_slot:
        description: "Scheduled slot (00:30 or 14:00)"
        required: false
        default: "14:00"
        type: choice
        options:
          - "14:00"
          - "00:30"
      offsets_csv:
        description: "Offsets in days, CSV (e.g. 90,60,30 or 30)"
        required: false
        default: "90,60,30"
        type: string
      today_override:
        description: "Override 'today' (YYYY-MM-DD). Leave empty to use Nairobi today."
        required: false
        default: ""
        type: string
      timeout_seconds:
        description: "HTTP call timeout seconds (5-120)"
        required: false
        default: "30"
        type: string

concurrency:
  group: lease-renewal-scheduler
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Validate secrets
        shell: bash
        env:
          SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${SRK:-}" ]; then
            echo "::error::Missing SUPABASE_SERVICE_ROLE_KEY secret."
            exit 1
          fi
          echo "SUPABASE_SERVICE_ROLE_KEY length: ${#SRK}"

      - name: Build payload
        id: payload
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_SLOT: ${{ inputs.scheduled_slot }}
          INPUT_OFFSETS: ${{ inputs.offsets_csv }}
          INPUT_TODAY: ${{ inputs.today_override }}
          INPUT_TIMEOUT: ${{ inputs.timeout_seconds }}
        run: |
          set -euo pipefail
          echo "Event: ${EVENT_NAME}"
          echo "Inputs scheduled_slot='${INPUT_SLOT}' offsets_csv='${INPUT_OFFSETS}' today_override='${INPUT_TODAY}' timeout_seconds='${INPUT_TIMEOUT}'"

          # Defaults for scheduled runs
          SLOT="14:00"
          OFFSETS_CSV="90,60,30"
          TODAY_OVERRIDE=""
          TIMEOUT="30"

          # Manual triggers can override
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            if [ -n "${INPUT_SLOT:-}" ]; then SLOT="${INPUT_SLOT}"; fi
            if [ -n "${INPUT_OFFSETS:-}" ]; then OFFSETS_CSV="${INPUT_OFFSETS}"; fi
            if [ -n "${INPUT_TODAY:-}" ]; then TODAY_OVERRIDE="${INPUT_TODAY}"; fi
            if [ -n "${INPUT_TIMEOUT:-}" ]; then TIMEOUT="${INPUT_TIMEOUT}"; fi
          fi

          # Validate slot
          if [ "${SLOT}" != "14:00" ] && [ "${SLOT}" != "00:30" ]; then
            echo "::error::Invalid scheduled_slot '${SLOT}'. Allowed: 14:00 or 00:30"
            exit 1
          fi

          # Validate timeout
          if ! [[ "${TIMEOUT}" =~ ^[0-9]+$ ]]; then
            echo "::error::timeout_seconds must be numeric. Got '${TIMEOUT}'"
            exit 1
          fi
          if [ "${TIMEOUT}" -lt 5 ] || [ "${TIMEOUT}" -gt 120 ]; then
            echo "::error::timeout_seconds out of range (5-120). Got '${TIMEOUT}'"
            exit 1
          fi

          # Convert CSV offsets -> JSON array (strict numeric parsing)
          OFFSETS_JSON="$(echo "${OFFSETS_CSV}" | awk -F',' '{
            printf "[";
            outCount=0;
            for (i=1; i<=NF; i++) {
              gsub(/^[ \t]+|[ \t]+$/, "", $i);
              if ($i ~ /^[0-9]+$/) {
                if (outCount>0) printf ",";
                printf "%s", $i;
                outCount++;
              }
            }
            printf "]";
          }')"

          if [ "${OFFSETS_JSON}" = "[]" ]; then
            echo "::error::Offsets CSV invalid or empty: '${OFFSETS_CSV}'. Example valid: 90,60,30"
            exit 1
          fi

          # Build JSON payload
          if [ -n "${TODAY_OVERRIDE}" ]; then
            PAYLOAD="{\"scheduled_slot\":\"${SLOT}\",\"offsets\":${OFFSETS_JSON},\"todayOverride\":\"${TODAY_OVERRIDE}\"}"
          else
            PAYLOAD="{\"scheduled_slot\":\"${SLOT}\",\"offsets\":${OFFSETS_JSON}}"
          fi

          echo "Final SLOT=${SLOT}"
          echo "Final OFFSETS_JSON=${OFFSETS_JSON}"
          echo "Final TODAY_OVERRIDE='${TODAY_OVERRIDE}'"
          echo "Final TIMEOUT=${TIMEOUT}"
          echo "Final PAYLOAD=${PAYLOAD}"

          echo "payload=${PAYLOAD}" >> $GITHUB_OUTPUT
          echo "timeout=${TIMEOUT}" >> $GITHUB_OUTPUT

      - name: Call Edge Function - lease-renewal-scheduler (always prints status/body)
        shell: bash
        env:
          SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PAYLOAD: ${{ steps.payload.outputs.payload }}
          TIMEOUT: ${{ steps.payload.outputs.timeout }}
        run: |
          set -euo pipefail

          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/lease-renewal-scheduler"
          echo "Calling: ${URL}"
          echo "Timeout: ${TIMEOUT}s"
          echo "Payload: ${PAYLOAD}"

          BODY_FILE="$(mktemp)"
          HTTP_CODE="$(curl -sS --max-time "${TIMEOUT}" \
            -o "${BODY_FILE}" \
            -w "%{http_code}" \
            -X POST "${URL}" \
            -H "Authorization: Bearer ${SRK}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" || true)"

          echo "HTTP status: ${HTTP_CODE}"
          echo "Response body (raw):"
          cat "${BODY_FILE}" || true
          echo ""

          if [[ "${HTTP_CODE}" -lt 200 || "${HTTP_CODE}" -ge 300 ]]; then
            echo "::error::Edge function call failed. HTTP ${HTTP_CODE}. See response body in logs."
            exit 1
          fi
