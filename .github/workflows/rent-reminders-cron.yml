name: Rent Reminders Cron

on:
  schedule:
    - cron: "5 0 * * *"    # 00:05 UTC — billing/status normalize
    - cron: "20 0 * * *"   # 00:20 UTC — trigger reminders
    - cron: "30 0 * * *"   # 00:30 UTC — dispatch reminders
    - cron: "0 14 * * *"   # 14:00 UTC — dispatch retry / in-app second push

  workflow_dispatch:
    inputs:
      job:
        description: "Choose what to run"
        required: true
        type: choice
        options:
          - billing-status
          - trigger
          - dispatch-0030
          - dispatch-1400

      # -------- Trigger testing --------
      today_override:
        description: "Trigger test only. YYYY-MM-DD. Requires DEBUG_CRON_SECRET + ALLOW_TODAY_OVERRIDE=true in Supabase."
        required: false
        type: string

      trigger_dry_run:
        description: "Trigger test only. If true, computes matches but does not write reminders (requires DEBUG_CRON_SECRET)."
        required: false
        type: choice
        options: ["false", "true"]
        default: "false"

      force_send_now:
        description: "Trigger test only. If true, schedules reminders for immediate dispatch (requires DEBUG_CRON_SECRET + ALLOW_TODAY_OVERRIDE=true in Supabase)."
        required: false
        type: choice
        options: ["false", "true"]
        default: "false"

      # -------- Dispatch testing --------
      dry_run:
        description: "Dispatch test only. If true, do not send SMS / do not write communications (requires DEBUG_CRON_SECRET)."
        required: false
        type: choice
        options: ["false", "true"]
        default: "false"

      now_override:
        description: "Dispatch test only. ISO datetime or YYYY-MM-DD. Requires DEBUG_CRON_SECRET + ALLOW_NOW_OVERRIDE=true in Supabase."
        required: false
        type: string

      limit:
        description: "Dispatch batch limit (1..500). Default 200."
        required: false
        type: string
        default: "200"

env:
  SUPABASE_PROJECT_REF: bqcqacqchyrjckrapcar
  BASE_URL: https://bqcqacqchyrjckrapcar.supabase.co/functions/v1

jobs:
  # -----------------------------
  # Common secret validation
  # -----------------------------
  secrets-check:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.check.outputs.ok }}
    steps:
      - name: Ensure required secrets are set
        id: check
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "ERROR: GitHub Actions secret CRON_SECRET is not set."
            exit 1
          fi

          # For workflow_dispatch: require DEBUG_CRON_SECRET when overrides/dry_run/force_send_now used
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            NEED_DEBUG="false"
            if [ "${{ inputs.today_override }}" != "" ]; then NEED_DEBUG="true"; fi
            if [ "${{ inputs.trigger_dry_run }}" = "true" ]; then NEED_DEBUG="true"; fi
            if [ "${{ inputs.force_send_now }}" = "true" ]; then NEED_DEBUG="true"; fi
            if [ "${{ inputs.now_override }}" != "" ]; then NEED_DEBUG="true"; fi
            if [ "${{ inputs.dry_run }}" = "true" ]; then NEED_DEBUG="true"; fi

            if [ "$NEED_DEBUG" = "true" ] && [ -z "${{ secrets.DEBUG_CRON_SECRET }}" ]; then
              echo "ERROR: DEBUG_CRON_SECRET is required for override/dry_run/force_send_now runs."
              echo "Add GitHub Actions secret DEBUG_CRON_SECRET to match Supabase DEBUG_CRON_SECRET."
              exit 1
            fi
          fi

          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "Secrets check OK."

  # -----------------------------
  # 1) billing-status
  # -----------------------------
  billing-status:
    needs: [secrets-check]
    runs-on: ubuntu-latest
    if: |
      needs.secrets-check.outputs.ok == 'true' &&
      (
        (github.event_name == 'schedule' && github.event.schedule == '5 0 * * *') ||
        (github.event_name == 'workflow_dispatch' && inputs.job == 'billing-status')
      )
    steps:
      - name: Print context
        shell: bash
        run: |
          echo "Running billing-status"
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"

      - name: Billing status (normalize invoice statuses)
        shell: bash
        run: |
          set -euo pipefail
          URL="${{ env.BASE_URL }}/billing-status"
          echo "Calling: $URL"

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            -d '{}')

          echo "HTTP $HTTP_CODE"
          cat response.json || true
          echo ""

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

  # -----------------------------
  # 2) reminders-trigger (scheduler)
  # -----------------------------
  trigger:
    needs: [secrets-check]
    runs-on: ubuntu-latest
    if: |
      needs.secrets-check.outputs.ok == 'true' &&
      (
        (github.event_name == 'schedule' && github.event.schedule == '20 0 * * *') ||
        (github.event_name == 'workflow_dispatch' && inputs.job == 'trigger')
      )
    steps:
      - name: Print context
        shell: bash
        run: |
          echo "Running trigger"
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
          echo "today_override: '${{ inputs.today_override }}'"
          echo "trigger_dry_run: '${{ inputs.trigger_dry_run }}'"
          echo "force_send_now: '${{ inputs.force_send_now }}'"

      - name: Trigger reminders (create reminders from invoices)
        shell: bash
        run: |
          set -euo pipefail

          URL="${{ env.BASE_URL }}/reminders-trigger"
          echo "Calling: $URL"

          PAYLOAD='{}'

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TODAY="${{ inputs.today_override }}"
            TDRY="${{ inputs.trigger_dry_run }}"
            FSEND="${{ inputs.force_send_now }}"

            # Build payload
            PAYLOAD="{"
            FIRST="true"

            if [ "$TODAY" != "" ]; then
              if [ "$FIRST" = "true" ]; then FIRST="false"; else PAYLOAD="$PAYLOAD,"; fi
              PAYLOAD="$PAYLOAD\"today_override\":\"$TODAY\""
            fi

            if [ "$TDRY" = "true" ]; then
              if [ "$FIRST" = "true" ]; then FIRST="false"; else PAYLOAD="$PAYLOAD,"; fi
              PAYLOAD="$PAYLOAD\"dry_run\":true"
            fi

            if [ "$FSEND" = "true" ]; then
              if [ "$FIRST" = "true" ]; then FIRST="false"; else PAYLOAD="$PAYLOAD,"; fi
              PAYLOAD="$PAYLOAD\"force_send_now\":true"
            fi

            PAYLOAD="$PAYLOAD}"
          fi

          echo "Payload: $PAYLOAD"

          DEBUG_HEADER=()
          if echo "$PAYLOAD" | grep -qE '"today_override":|"dry_run":true|"force_send_now":true'; then
            DEBUG_HEADER=(-H "x-debug-cron-secret: ${{ secrets.DEBUG_CRON_SECRET }}")
          fi

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            "${DEBUG_HEADER[@]}" \
            --data "$PAYLOAD")

          echo "HTTP $HTTP_CODE"
          cat response.json || true
          echo ""

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

  # -----------------------------
  # 3) reminders-dispatch (00:30)
  # -----------------------------
  dispatch-0030:
    needs: [secrets-check]
    runs-on: ubuntu-latest
    if: |
      needs.secrets-check.outputs.ok == 'true' &&
      (
        (github.event_name == 'schedule' && github.event.schedule == '30 0 * * *') ||
        (github.event_name == 'workflow_dispatch' && inputs.job == 'dispatch-0030')
      )
    steps:
      - name: Print context
        shell: bash
        run: |
          echo "Running dispatch-0030"
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
          echo "now_override: '${{ inputs.now_override }}'"
          echo "dry_run: '${{ inputs.dry_run }}'"
          echo "limit: '${{ inputs.limit }}'"

      - name: Dispatch reminders (00:30 slot)
        shell: bash
        run: |
          set -euo pipefail

          URL="${{ env.BASE_URL }}/reminders-dispatch"
          echo "Calling: $URL"

          LIMIT="${{ inputs.limit }}"
          if [ -z "$LIMIT" ]; then LIMIT="200"; fi

          # Default scheduled run payload
          PAYLOAD="{\"limit\":200}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DRY="${{ inputs.dry_run }}"
            NOW="${{ inputs.now_override }}"

            if [ "$DRY" = "true" ] && [ "$NOW" != "" ]; then
              PAYLOAD="{\"dry_run\":true,\"now_override\":\"$NOW\",\"limit\":$LIMIT}"
            elif [ "$DRY" = "true" ]; then
              PAYLOAD="{\"dry_run\":true,\"limit\":$LIMIT}"
            elif [ "$NOW" != "" ]; then
              PAYLOAD="{\"now_override\":\"$NOW\",\"limit\":$LIMIT}"
            else
              PAYLOAD="{\"limit\":$LIMIT}"
            fi
          fi

          echo "Payload: $PAYLOAD"

          DEBUG_HEADER=()
          if echo "$PAYLOAD" | grep -qE '"dry_run":true|"now_override":'; then
            DEBUG_HEADER=(-H "x-debug-cron-secret: ${{ secrets.DEBUG_CRON_SECRET }}")
          fi

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            "${DEBUG_HEADER[@]}" \
            --data "$PAYLOAD")

          echo "HTTP $HTTP_CODE"
          cat response.json || true
          echo ""

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

  # -----------------------------
  # 4) reminders-dispatch (14:00)
  # -----------------------------
  dispatch-1400:
    needs: [secrets-check]
    runs-on: ubuntu-latest
    if: |
      needs.secrets-check.outputs.ok == 'true' &&
      (
        (github.event_name == 'schedule' && github.event.schedule == '0 14 * * *') ||
        (github.event_name == 'workflow_dispatch' && inputs.job == 'dispatch-1400')
      )
    steps:
      - name: Print context
        shell: bash
        run: |
          echo "Running dispatch-1400"
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
          echo "now_override: '${{ inputs.now_override }}'"
          echo "dry_run: '${{ inputs.dry_run }}'"
          echo "limit: '${{ inputs.limit }}'"

      - name: Dispatch reminders (14:00 slot)
        shell: bash
        run: |
          set -euo pipefail

          URL="${{ env.BASE_URL }}/reminders-dispatch"
          echo "Calling: $URL"

          LIMIT="${{ inputs.limit }}"
          if [ -z "$LIMIT" ]; then LIMIT="200"; fi

          # Default scheduled run payload
          PAYLOAD="{\"limit\":200}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DRY="${{ inputs.dry_run }}"
            NOW="${{ inputs.now_override }}"

            if [ "$DRY" = "true" ] && [ "$NOW" != "" ]; then
              PAYLOAD="{\"dry_run\":true,\"now_override\":\"$NOW\",\"limit\":$LIMIT}"
            elif [ "$DRY" = "true" ]; then
              PAYLOAD="{\"dry_run\":true,\"limit\":$LIMIT}"
            elif [ "$NOW" != "" ]; then
              PAYLOAD="{\"now_override\":\"$NOW\",\"limit\":$LIMIT}"
            else
              PAYLOAD="{\"limit\":$LIMIT}"
            fi
          fi

          echo "Payload: $PAYLOAD"

          DEBUG_HEADER=()
          if echo "$PAYLOAD" | grep -qE '"dry_run":true|"now_override":'; then
            DEBUG_HEADER=(-H "x-debug-cron-secret: ${{ secrets.DEBUG_CRON_SECRET }}")
          fi

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            "${DEBUG_HEADER[@]}" \
            --data "$PAYLOAD")

          echo "HTTP $HTTP_CODE"
          cat response.json || true
          echo ""

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi
