name: M-Pesa Auto Verify (Edge)

on:
  schedule:
    # Every 5 minutes (UTC). Best-effort by GitHub.
    - cron: "*/5 * * * *"

  workflow_dispatch:
    inputs:
      limit:
        description: "Max records to process (overrides default)"
        required: false
        default: "100"

concurrency:
  group: mpesa-auto-verify
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call Supabase Edge Function (mpesa-auto-verify)
        env:
          URL: ${{ secrets.SUPABASE_EDGE_MPESA_AUTOVERIFY_URL }}
          SECRET: ${{ secrets.SUPABASE_CRON_SECRET }}
          DEFAULT_LIMIT: ${{ secrets.MPESA_VERIFY_LIMIT }}
          INPUT_LIMIT: ${{ github.event.inputs.limit }}
        run: |
          set -euo pipefail

          echo "=== M-Pesa Auto Verify (Edge) ==="

          if [ -z "${URL:-}" ]; then
            echo "::error::Missing SUPABASE_EDGE_MPESA_AUTOVERIFY_URL secret"
            exit 1
          fi

          if [ -z "${SECRET:-}" ]; then
            echo "::error::Missing SUPABASE_CRON_SECRET secret"
            exit 1
          fi

          # Resolve limit (manual input > repo secret > fallback)
          LIMIT="${INPUT_LIMIT:-}"
          if [ -z "${LIMIT}" ]; then
            LIMIT="${DEFAULT_LIMIT:-}"
          fi
          if [ -z "${LIMIT}" ]; then
            LIMIT="100"
          fi

          FULL_URL="${URL}?limit=${LIMIT}"

          echo "Calling URL: ${FULL_URL}"
          echo "Secret length: ${#SECRET} (not printing value)"

          # --- CRITICAL FIX: use x-cron-secret header ---
          HTTP_CODE=$(curl -sS \
            -D resp.headers \
            -o resp.json \
            -w "%{http_code}" \
            -X POST \
            -H "x-cron-secret: ${SECRET}" \
            -H "Content-Type: application/json" \
            "${FULL_URL}"
          )

          echo "HTTP ${HTTP_CODE}"
          echo "---- Response headers ----"
          cat resp.headers || true
          echo "---- Response body ----"
          cat resp.json || true

          if [ "${HTTP_CODE}" -lt 200 ] || [ "${HTTP_CODE}" -ge 300 ]; then
            echo "::error::Edge function call failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

          echo "âœ” M-Pesa auto-verify completed successfully"
