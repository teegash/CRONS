name: Rent Reminders Cron

on:
  schedule:
    - cron: '5 0 * * *'    # 00:05 UTC — billing/status normalize
    - cron: '20 0 * * *'   # 00:20 UTC — trigger reminders
    - cron: '30 0 * * *'   # 00:30 UTC — dispatch reminders
    - cron: '0 14 * * *'   # 14:00 UTC — dispatch retry / in-app second push
  workflow_dispatch:
    inputs:
      job:
        description: 'Choose what to run'
        required: true
        type: choice
        options:
          - billing-status
          - trigger
          - dispatch-0030
          - dispatch-1400

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Set mode
        id: mode
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.job }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event.schedule }}" = "5 0 * * *" ]; then
            echo "mode=billing-status" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event.schedule }}" = "20 0 * * *" ]; then
            echo "mode=trigger" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event.schedule }}" = "30 0 * * *" ]; then
            echo "mode=dispatch-0030" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ github.event.schedule }}" = "0 14 * * *" ]; then
            echo "mode=dispatch-1400" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "mode=unknown" >> "$GITHUB_OUTPUT"

      - name: Print mode
        run: echo "Mode is ${{ steps.mode.outputs.mode }}"

      - name: Ensure CRON_SECRET is set
        shell: bash
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "ERROR: GitHub Actions secret CRON_SECRET is not set."
            echo "Fix: Repo Settings -> Secrets and variables -> Actions -> New repository secret"
            exit 1
          fi
          echo "CRON_SECRET is set (value hidden)."

      - name: Billing status (normalize invoice statuses)
        if: steps.mode.outputs.mode == 'billing-status'
        shell: bash
        run: |
          set -e
          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/billing-status"
          echo "Calling: $URL"

          http_code=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            -d '{}')

          echo "HTTP $http_code"
          echo "Response:"
          cat response.json || true
          echo ""

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

      - name: Trigger reminders
        if: steps.mode.outputs.mode == 'trigger'
        shell: bash
        run: |
          set -e
          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-trigger"
          echo "Calling: $URL"

          http_code=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            -d '{}')

          echo "HTTP $http_code"
          echo "Response:"
          cat response.json || true
          echo ""

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

      - name: Dispatch reminders 0030
        if: steps.mode.outputs.mode == 'dispatch-0030'
        shell: bash
        run: |
          set -e
          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-dispatch"
          echo "Calling: $URL"

          http_code=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            -d '{}')

          echo "HTTP $http_code"
          echo "Response:"
          cat response.json || true
          echo ""

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

      - name: Dispatch reminders 1400
        if: steps.mode.outputs.mode == 'dispatch-1400'
        shell: bash
        run: |
          set -e
          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-dispatch"
          echo "Calling: $URL"

          http_code=$(curl -sS -o response.json -w "%{http_code}" -X POST \
            "$URL" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "content-type: application/json" \
            -d '{}')

          echo "HTTP $http_code"
          echo "Response:"
          cat response.json || true
          echo ""

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Request failed"
            exit 1
          fi

      - name: Unknown mode guard
        if: steps.mode.outputs.mode == 'unknown'
        shell: bash
        run: |
          echo "ERROR: Unknown schedule mapping."
          echo "github.event.schedule was: ${{ github.event.schedule }}"
          exit 1
