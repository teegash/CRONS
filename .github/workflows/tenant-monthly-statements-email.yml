name: Tenant Monthly Statements Email

on:
  schedule:
    # 18:05 Nairobi = 15:05 UTC
    - cron: "5 15 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        type: choice
        options:
          - normal
          - force_last_day_test
      as_of_override:
        description: "Optional YYYY-MM-DD override (testing only)"
        required: false
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function (Monthly Statements)
        shell: bash
        env:
          MODE: ${{ github.event.inputs.mode }}
          AS_OF: ${{ github.event.inputs.as_of_override }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          DEBUG_CRON_SECRET: ${{ secrets.DEBUG_CRON_SECRET }}
        run: |
          set -euo pipefail

          # Use the exact function URL you provided (Supabase gateway form)
          URL="https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/cron-tenant-statements-monthly-email"

          echo "Calling: ${URL}"
          echo "Mode: ${MODE:-normal}"
          echo "As-of override: ${AS_OF:-}"

          if [[ "${MODE:-normal}" == "force_last_day_test" ]]; then
            echo "Running in FORCE LAST DAY (TEST) mode"
            PAYLOAD="{\"force_last_day\":true,\"as_of_override\":\"${AS_OF:-}\"}"

            HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
              -X POST "${URL}" \
              -H "x-cron-secret: ${CRON_SECRET}" \
              -H "x-debug-cron-secret: ${DEBUG_CRON_SECRET}" \
              -H "Content-Type: application/json" \
              --data "${PAYLOAD}" || true)
          else
            echo "Running in NORMAL mode"
            HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
              -X POST "${URL}" \
              -H "x-cron-secret: ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              --data '{}' || true)
          fi

          echo "HTTP: ${HTTP_CODE}"
          echo "Response:"
          cat response.json || true

          if [[ "${HTTP_CODE}" -lt 200 || "${HTTP_CODE}" -ge 300 ]]; then
            echo "Request failed"
            exit 1
          fi
