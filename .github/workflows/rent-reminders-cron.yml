name: Rent Reminders Cron

on:
  schedule:
    # 00:20 UTC — trigger reminders
    - cron: "20 0 * * *"
    # 00:30 UTC — dispatch reminders
    - cron: "30 0 * * *"
    # 14:00 UTC — dispatch retry (and in-app second push)
    - cron: "0 14 * * *"

  workflow_dispatch:
    inputs:
      job:
        description: "Choose what to run"
        required: true
        type: choice
        options:
          - trigger
          - dispatch-0030
          - dispatch-1400

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Decide mode (scheduled vs manual)
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.job }}" >> $GITHUB_OUTPUT
          else
            # scheduled run: map cron string to mode
            if [ "${{ github.event.schedule }}" = "20 0 * * *" ]; then
              echo "mode=trigger" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.schedule }}" = "30 0 * * *" ]; then
              echo "mode=dispatch-0030" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.schedule }}" = "0 14 * * *" ]; then
              echo "mode=dispatch-1400" >> $GITHUB_OUTPUT
            else
              echo "mode=unknown" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Print selected mode
        run: echo "Selected mode: ${{ steps.mode.outputs.mode }}"

      - name: Trigger reminders (00:20)
        if: steps.mode.outputs.mode == 'trigger'
        run: |
          curl -sS -X POST \
            "https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-trigger" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}"

      - name: Dispatch reminders (00:30)
        if: steps.mode.outputs.mode == 'dispatch-0030'
        run: |
          curl -sS -X POST \
            "https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-dispatch" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}"

      - name: Dispatch reminders (14:00)
        if: steps.mode.outputs.mode == 'dispatch-1400'
        run: |
          curl -sS -X POST \
            "https://bqcqacqchyrjckrapcar.supabase.co/functions/v1/reminders-dispatch" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}"
